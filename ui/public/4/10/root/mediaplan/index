[% INCLUDE _inc/_html_head %]
  <body>
    <div class="wrap lp-center panel-page mediaplan">
      <div class="inner">
        <div class="wrap lp-top panel-global_head">
          <div class="inner">
            [% INCLUDE _inc/_header %]
            [% INCLUDE _inc/_tabs_panel %]
          </div>
        </div>
        <div class="wrap lp-top panel-mediaplan_head">
          <div class="inner mform">
            <div style='float: right;'>
              Групповые операции: 
              <select id='groupAPISelector' data-mediaplan-id='[% title.mediaplan_id %]' data-group_api_domain_name='[% group_api_domain_name %]'>
                <option value='' selected></option>
                <option value='bannerManager'>Баннеры</option>
                <option value='creativeManager'>Креативы</option>
                <option value='geoTargetingChange'>Настройка гео-таргетинга</option>
                <option value='siteTargetingChange'>Настройка сайтового таргетинга</option>
                <option value='targetURLChange'>Изменение target_url</option>
                <option value='profileExposurePriceEditor'>Изменение exposure_price</option>
              </select>
            </div>
            <dl class="inline">
              <dt class="label">Медиаплан:</dt>
              <dd class="value">[% title.mediaplan %] (<span class="plink" onClick="load_dialog('[% C.uri_for_action('/mediaplan/edit', [title.mediaplan_id]) %]','d_mediaplan'); showDialog('d_mediaplan')"><span>Изменить</span></span>)</dd>
            </dl>
            <dl class="inline">
              <dt class="label">Клиент:</dt>
              <dd class="value">[% title.advertiser %]</dd>
            </dl>
            <dl class="inline">
              <dt class="label">Продавец:</dt>
              <dd class="value">[% title.sales_manager %] <span class="email">(<a href="mailto:[% title.sales_manager_email %]">[% title.sales_manager_email %]</a>)</span></dd>
            </dl>
            <dl class="inline">
              <dt class="label">Аккаунт-менеджер:</dt>
              <dd class="value">[% title.account_manager %] <span class="email">(<a href="mailto:[% title.account_manager_email %]">[% title.account_manager_email %]</a>)</span></dd>
            </dl>
          </div>
        </div>
        <div class="wrap lp-top panel-global_actions">
          <form name="filter" method="get" action="[% C.uri_for_action(C.action, [title.mediaplan_id]) %]">
            <div class="inner mform">
              <input type="button" value="Добавить контрольную точку" onClick="load_dialog('[% C.uri_for_action('/lines/cpoint/create', [], {mediaplan_id => title.mediaplan_id}) %]','d_cpoint'); showCPointDialog('d_cpoint');" />
              [% INCLUDE _inc/_stat_filter %]
              [% INCLUDE _inc/_extra_filters %]
            </div>
            <input id="sorted_column" type="hidden" name="sorted_column" value="[% filter.sorted_column %]"/>
            <script language="Javascript" src="/js/mediaplan.js"></script>
          </form>
        </div>

        [% MACRO def_sorted_column(column) IF filter.sorted_column == column %]class="sorted"[% END %]
        [% MACRO set_sorted_column(column) BLOCK %]javascript:$('sorted_column').value='[% column %]';document.filter.submit()[% END %]
        [% INCLUDE _inc/_stat_update_time %]
        <div class="wrap lp-center">
          <div class="inner panel-tbody">
            <table class="fixed striped" style="display: none; width: auto;">
	          <colgroup span="3">
		          <col [% def_sorted_column('line_title') %] />
		          <col/>
		          <col/>
	          </colgroup>
	          <colgroup>

		          <col [% def_sorted_column('impressions') %] />
		          <col [% def_sorted_column('clicks') %] />
		          <col [% def_sorted_column('CTR') %] />
		          <col [% def_sorted_column('costs_est') %] />
		          <col [% def_sorted_column('costs') %] />
		          <col [% def_sorted_column('costs_real') %] />
		          <col [% def_sorted_column('CPM') %] />

		          <col [% IF filter.sorted_column == 'leads' %] class="sorted" [% ELSE %] class="leads" [% END %] />
		          <col [% def_sorted_column('lead_cost_est') %] />
		          <col [% def_sorted_column('lead_cost_our') %] />
              <col [% def_sorted_column('lead_cost') %] />
		          <col [% def_sorted_column('lead_cost_real') %] />
              <col [% def_sorted_column('profitability') %] />
              <col [% def_sorted_column('deviation') %] />

		          <col [% def_sorted_column('lead_rate') %] />
		          <col [% def_sorted_column('conversion_rate') %] />

		          <col [% def_sorted_column('leads_reach') %] />
		          <col [% def_sorted_column('leads_uniq') %] />
		          <col [% def_sorted_column('leads_nu') %] />
		          <col [% def_sorted_column('leads_other') %] />
		          <col [% def_sorted_column('leads_proper') %] />
	          </colgroup>
              <thead>
               <tr>
                 <td style="width: 16em;" class="sortable" onclick="[% set_sorted_column('line_title') %]"><div class="colheader">Контрольная точка</div></td>
                 <td style="width: 34px;"><div class="colheader"></div></td>
                 <td style="width: 13em;"><div class="colheader">Период</div></td>

                 <td style="width: 8em;" class="sortable collapsable r" onclick="[% set_sorted_column('impressions') %]"><div class="colheader">Показы</div></td>
                 <td style="width: 6em;" class="sortable collapsable r" onclick="[% set_sorted_column('clicks') %]"><div class="colheader">Клики</div></td>
                 <td style="width: 5em;" class="sortable collapsable r" onclick="[% set_sorted_column('CTR') %]"><div class="colheader">CTR, %</div></td>
                 <td style="width: 7em;" class="sortable collapsable r" onclick="[% set_sorted_column('costs_est') %]"><div class="colheader">Estimated Costs</div></td>
                 <td style="width: 7em;" class="sortable collapsable r" onclick="[% set_sorted_column('costs') %]"><div class="colheader">CPM/CPC Costs</div></td>
                 <td style="width: 7em;" class="sortable collapsable r" onclick="[% set_sorted_column('costs_real') %]"><div class="colheader">Real Costs</div></td>
                 <td style="width: 7em;" class="sortable collapsable r" onclick="[% set_sorted_column('CPM') %]"><div class="colheader">CPM</div></td>

                 <td style="width: 8em;" class="sortable collapsable r" onclick="[% set_sorted_column('leads') %]"><div class="colheader">Leads</div></td>
                 <td style="width: 5em;" class="sortable collapsable r" title="Estimated Lead Cost" onclick="[% set_sorted_column('lead_cost_est') %]"><div class="colheader">Estim. LC</div></td>
                 <td style="width: 5em;" class="sortable collapsable r" title="CPM/CPC Lead Cost by our stat" onclick="[% set_sorted_column('lead_cost_our') %]"><div class="colheader">Our LC</div></td>
                 <td style="width: 5em;" class="sortable collapsable r" title="CPM/CPC Lead Cost by client stat" onclick="[% set_sorted_column('lead_cost') %]"><div class="colheader">Lead Cost</div></td>
                 <td style="width: 5em;" class="sortable collapsable r" title="Real Lead Cost" onclick="[% set_sorted_column('lead_cost_real') %]"><div class="colheader">Real LC</div></td>
                 <td style="width: 6em;" class="sortable collapsable r" onclick="[% set_sorted_column('profitability') %]"><div class="colheader">Рентаб, %</div></td>
                 <td style="width: 6em;" class="sortable collapsable r" onclick="[% set_sorted_column('deviation') %]"><div class="colheader">Deviation</div></td>

                 <td style="width: 6em;" class="sortable collapsable r" onclick="[% set_sorted_column('lead_rate') %]"><div class="colheader">Lead Rate, %</div></td>
                 <td style="width: 7em;" class="sortable collapsable r" onclick="[% set_sorted_column('conversion_rate') %]"><div class="colheader">Conversion Rate, %</div></td>

                 <td style="width: 6em;" class="sortable collapsable r" onclick="[% set_sorted_column('leads_reach') %]"><div class="colheader">Leads Reach</div></td>
                 <td style="width: 6em;" class="sortable collapsable r" onclick="[% set_sorted_column('leads_uniq') %]"><div class="colheader">Leads Unique</div></td>
                 <td style="width: 7em;" class="sortable collapsable r" onclick="[% set_sorted_column('leads_nu') %]"><div class="colheader">Leads Non Unique</div></td>
                 <td style="width: 6em;" class="sortable collapsable r" onclick="[% set_sorted_column('leads_other') %]"><div class="colheader">Leads Other</div></td>
                 <td style="width: 6em;" class="sortable collapsable r" onclick="[% set_sorted_column('leads_proper') %]"><div class="colheader">Leads Proper</div></td>
               </tr>
              </thead>
              <tbody>
                [% total = data.pop %]
                [% IF filter.sorted_column == 'line_title';
                     sorted_data = data.sort('line_title');
                   ELSE;
                     sorted_data = data.nsort(filter.sorted_column).reverse;
                   END
                %]
                [% FOREACH row IN sorted_data %]
                <tr title="[% row.line_title %]">
                  <td><a href="[% C.uri_for_action('/lines/cpoint/index', [row.line_id]) %]">[% row.line_title %]</a></td>
	                <td>
		                <div class="inline-block">
			                <ins title="Изменить" class="sprite32bit size16x16 i16_edit clickable" onClick="load_dialog('[% C.uri_for_action('/lines/cpoint/edit', [row.line_id]) %]','d_cpoint'); showCPointDialog('d_cpoint');" onMouseOver="Element.addClassName(this.parentNode.parentNode.parentNode,'over'); Element.addClassName(this,'i16_edit_over');" onMouseOut="Element.removeClassName(this,'i16_edit_over');  Element.removeClassName(this.parentNode.parentNode.parentNode,'over');">
				                <i></i></ins>
			                <ins title="Удалить" class="sprite32bit size16x16 i16_del clickable" onClick="delete_object('[% C.uri_for_action('/lines/cpoint/delete', [row.line_id]) %]', 'Удалить «[% row.line_title %]» ?\n\n');" onMouseOver="Element.addClassName(this.parentNode.parentNode.parentNode,'over'); Element.addClassName(this,'i16_del_over');" onMouseOut="Element.removeClassName(this,'i16_del_over'); Element.removeClassName(this.parentNode.parentNode.parentNode,'over');">
				                <i></i></ins>
		                </div>
	                </td>
	                <td class="numeric"><a href="[% C.uri_for_action('/lines/cpoint/dailystat/index', [row.line_id]) %]">[% row.start_date %] &#150; [% row.stop_date %]</a></td>
                  <td class="numeric">[% row.impressions %]</td>
                  <td class="numeric">[% row.clicks %]</td>
                  <td class="numeric">[% row.CTR %]<span class="percent">%</span></td>
                  <td class="numeric">[% row.costs_est %]</td>
                  <td class="numeric">[% row.costs %]</td>
                  <td class="numeric[% IF row.exists('costs_check_ok') and not row.costs_check_ok %] att[% END %]">[% row.costs_real %]</td>
                  <td class="numeric">[% row.CPM %]</td>
                  [% IF row.stat_type == 'client' -%]
                  <td class="nowrap[% IF row.line_status == 'finished' %] att[% END %]">
                    <div class="inline-block numeric">
                     [% IF row.leads_auto_import %]<i class="ui-icon autoupdate" title="Настроен автоматический импорт"></i>[% END %]<ins title="Изменить" class="sprite32bit size16x16 i16_edit_blue clickable" onClick="dialog_url = '[% C.uri_for_action('/lines/cpoint/clientstat/edit', [row.line_id]) %]'; load_dialog(dialog_url,'d_client_stat'); showDialog('d_client_stat');" onMouseOver="Element.addClassName(this.parentNode.parentNode.parentNode,'over'); Element.addClassName(this,'i16_edit_over');" onMouseOut="Element.removeClassName(this,'i16_edit_over');  Element.removeClassName(this.parentNode.parentNode.parentNode,'over');"><i></i></ins>
                     [% IF row.leads; row.leads; ELSE %]&nbsp;[% END %]
                    </div>
                  </td>
                  [% ELSE -%]
                    <td class="numeric[% IF row.line_status == 'finished' %] att[% END %]">[% row.leads %]</td>
                  [% END -%]
                  <td class="numeric">[% row.lead_cost_est %]</td>
                  <td class="numeric">[% row.lead_cost_our %]</td>
                  <td class="numeric">[% row.lead_cost %]</td>
                  <td class="numeric">[% row.lead_cost_real %]</td>
                  <td class="numeric[% IF row.highlight_profitability %] att[% END %]">[% row.profitability %]</td>
                  <td class="numeric">[% row.deviation %]</td>
                  <td class="numeric">[% row.lead_rate %]<span class="percent">%</span></td>
                  <td class="numeric">[% row.conversion_rate %]<span class="percent">%</span></td>
                  <td class="numeric">[% row.leads_reach %]</td>
                  <td class="numeric">[% row.leads_uniq %]</td>
                  <td class="numeric">[% row.leads_nu %]</td>
                  <td class="numeric">[% row.leads_other %]</td>
                  <td class="numeric">[% row.leads_proper %]</td>
                </tr>
                [% END %]
              </tbody>
              <tfoot>
                <tr>
                  <td class="numeric"></td>
                  <td class="numeric"></td>
                  <td class="numeric">&#8721;</td>
                  <td class="numeric">[% total.impressions %]</td>
                  <td class="numeric">[% total.clicks %]</td>
                  <td class="numeric">[% total.CTR %]<span class="percent">%</span></td>
                  <td class="numeric">[% total.costs_est %]</td>
                  <td class="numeric">[% total.costs %]</td>
                  <td class="numeric">[% total.costs_real %]</td>
                  <td class="numeric">[% total.CPM %]</td>
                  <td class="numeric">[% total.leads %]</td>
                  <td class="numeric">[% total.lead_cost_est %]</td>
                  <td class="numeric">[% total.lead_cost_our %]</td>
                  <td class="numeric">[% total.lead_cost %]</td>
                  <td class="numeric">[% total.lead_cost_real %]</td>
                  <td class="numeric">[% total.profitability %]</td>
                  <td class="numeric">[% total.deviation %]</td>
                  <td class="numeric">[% total.lead_rate %]<span class="percent">%</span></td>
                  <td class="numeric">[% total.conversion_rate %]<span class="percent">%</span></td>
                  <td class="numeric">[% total.leads_reach %]</td>
                  <td class="numeric">[% total.leads_uniq %]</td>
                  <td class="numeric">[% total.leads_nu %]</td>
                  <td class="numeric">[% total.leads_other %]</td>
                  <td class="numeric">[% total.leads_proper %]</td>
                </tr>
              </tfoot>
              </table>
            </div>
          </div>
      </div>
    </div>

[% INCLUDE _inc/_dialogs %]
  </body>
</html>
